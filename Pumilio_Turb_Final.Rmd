---
title: "Pumilio_Turb_Final"
author: "Chloe Fouilloux"
date: '2023-02-01'
output: html_document
---

Welcome to our Oophaga pumilio tadpole turbidity code. You will find two other code files associated with this paper, (1) the Dendrobates tinctorius code, which involves a similar experiment with tadpoles from the Les Nouragues Field Station in French Guiana and (2) the water sample analysis file where I take spectrophotometry data and do color analysis of photographs.

In the following code, the values from (2) have already been calculated and are included in the data sheet. Please look at the "readme" file for variable descriptions.

First, let's load some packages

```{r pacakges}
library(dplyr)
library(ggplot2)
library(gghighlight)
library(ggtext)
library(gridExtra)
library(tidyverse)
library(forcats)
library(readr)
library(glmmTMB)
library(DHARMa)
library(lme4)
library(MASS)
library(sjPlot)

```

Theme Set

```{r ggplot custom theme}
theme_set(  theme(legend.position = "right",
                  strip.background = element_rect(fill = "White"),
                  panel.background = element_rect(fill = "white",
                                                  colour = "black"), 
                  panel.grid.major = element_line(size = 0), 
                  panel.grid.minor = element_line(size = 0), 
                  text = element_text(size = 14)))
```

Now, let's load some data

```{r Data Wrangling}

las<- read_csv("LAS_VISION_OCT2022.csv")

las <- las %>%
       mutate(Trial = as.factor(Trial),
              Tad_ID = as.factor(Tad_ID),
              Condition = as.factor(Condition),
              Predator = as.factor(Predator)) 
#activity
activity <- las %>%
           filter (Condition != "Background") %>%
           dplyr::select(! c("White", "Black")) %>%
           mutate(mass_diff_cons = Mass - Cons_g, 
                  pr_z1 = Zone_1/60, 
                  pr_swim = Swim/60)

activity$Predator<- forcats::fct_relevel(activity$Predator, 
                    c("Control", "Spider", "Conspecific"))

#Lets also look for black and white background trial
#background choice data
bw_choice_las <- las %>%
            filter (Condition == "Background") %>%
            mutate(p_black = Black/60, 
                   p_swim = Swim/60) 

```

################################### 

#### Statistics

################################### 

# Space use (Zone 1)

```{r Zone 1 counts by tadpoles with spectrophotometer data}


op_zone1_m1_full<- glmmTMB(Zone_1 ~ Condition * Predator * (Mean_Wave) + 
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

summary(op_zone1_m1_full) #weak 3 way interaction ( p = 0.0519)
#How does the full model look with respect to residuals?
simulationOutput <- simulateResiduals(fittedModel = op_zone1_m1_full)
plot(simulationOutput)

#Check three way interaction removed
step(op_zone1_m1_full)


####
# Trying different interaction structures#
####

#Condition * Predator
m2a<- glmmTMB(Zone_1 ~ 
                Condition * Predator + Mean_Wave + 
                Mass+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

#Predator * Mean_Wave
m2b<- glmmTMB(Zone_1 ~ 
                Condition + Predator * Mean_Wave + 
                Mass+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

#Condition * Mean_Wave
m2c<- glmmTMB(Zone_1 ~ 
                Condition * Mean_Wave  + Predator + 
                Mass+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

#Additive model
m2d<- glmmTMB(Zone_1 ~ 
                Condition + Mean_Wave  + Predator + 
                Mass+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 


#Let's compare model fits via AICc
aic.cand<- list(m2a, m2b, m2c, m2d)
mods<- c("m2a", "m2b", "m2c", "m2d")
aictab(aic.cand, mods, sort = T, second.ord = T)

```

Here we have models m2d and m2c that are within 1 AIC of each other, but since the interaction in m2c is not significant, let's drop it and just work with m2d.

```{r Zone 1 Checks and Table}

#Let's check the model fit and residuals using DHARMa
summary(m2d)

#run both lines at the same time
simulationOutput <- simulateResiduals(fittedModel = m2d) #no problems detected
plot(simulationOutput)
#
testDispersion(m2d) #fine
testZeroInflation(m2d) #good

```

(1) Now, for O. pumilio data we also have photograph data that we can compare with spectrophotometer data. Let's run the exact same model formulation with using photography instead of spectrophotometry data.

(2) Alright, there are two main ways to think about the tadpole size in this study. The first is to think about the absolute size of the focal tadpole (in grams) and the other is to think about the weight difference between the tadpole and the visual stimuli when faced with conspecifics. Here, I show that the model output does not change as a fuction of using one variable or the other. Ultimately, the size of the focal tadpole seems to be the most important predictive factor rather than relative size between tadpoles.

```{r Spectrophotometry/Photograph data + Absolute/Relative Mass for Zone 1}

############################
##### %R Channel Reflectance #####
############################ 

#best model for zone 1 was m2d, which found only background condition **White** to be significant.
#let's run this with the %R channel data

m2_rMean<- glmmTMB(Zone_1 ~ 
                Condition + log(rMean_OG)  + Predator + 
                log(Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

summary(m2_rMean) #same result!
simulationOutput <- simulateResiduals(fittedModel = m2_rMean)
plot(simulationOutput)

#tab model for photography data
tab_model(m2_rMean, 
          transform = NULL,
          show.ci = F, 
          show.est = T, 
          show.se = T, 
          show.stat = T,
          show.obs = F,
          show.r2 = F,
          string.stat = "z value",
          string.se = "SE", 
          dv.labels = "<i>O. pumilio</i> Space-use (zone 1 counts)",
          pred.labels = c("(Intercept)",
                         "Condition [White]",
                         "log(% R-ch reflectance)",
                        "Predator [Spider]",
                         "Predator [Cons.]", 
                         "Mass"))



############################
##### Absolute vs. Relative Tadpole Size #####
############################ 

#best model for zone 1 was m2d, which found only background condition **White** to be significant.
#let's run this with mass difference data

m2d.md<- glmmTMB(Zone_1 ~ 
                Condition + Mean_Wave  + Predator + 
                mass_diff_cons+(1|Tad_ID), data = activity, family = nbinom1) 

summary(m2d.md)
simulationOutput <- simulateResiduals(fittedModel = m2d.md)
plot(simulationOutput)

#same result!

```

Great! Now let's move on to activity!

# Activity (swimming)

As with the previous formulation, we will start with a full model interaction

```{r Swimming Activity Models with Spectrophotometry data}

op_swim_m1_full<- glmmTMB(Swim ~ 
                Condition * Predator * (Mean_Wave) + 
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 



summary(op_swim_m1_full) 

#Check three way interaction removed
step(op_swim_m1_full)

####
# Trying different interaction structures#
####

#Condition * Predator
m3a<- glmmTMB(Swim ~ 
                Condition * Predator + Mean_Wave + 
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 


#Predator * Mean_Wave
m3b<- glmmTMB(Swim ~ 
                Condition + Predator * Mean_Wave + 
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

#Condition * Mean_Wave
m3c<- glmmTMB(Swim ~ 
                Condition * Mean_Wave +  Predator +
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

#Additive model
m3d<- glmmTMB(Swim ~ 
                Condition + Mean_Wave +  Predator +
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 


#Let's compare model fits via AICc
aic.cand<- list(m3a, m3b, m3c, m3d)
mods<- c("m3a", "m3b", "m3c", "m3d")
aictab(aic.cand, mods, sort = T, second.ord = T)

#m3c, by a lot!

```

Now let's check the quality of m3c

```{r Swimming Checks}

#Let's check the model fit and residuals using DHARMa
summary(m3c)

#run both lines at the same time
simulationOutput <- simulateResiduals(fittedModel = m3c) #no problems detected
plot(simulationOutput)
#
testDispersion(m3c) #fine
testZeroInflation(m3c) #good

```

Let's look at these data from the photography perspective

```{r Spectrophotometry and Photograph data for Swim}

############################
  ##### r MEAN OG #####
############################ 

#best model for zone 1 was m3c, which found (1) interaction between background*intensity, (2) tadpole mass, and (3) background w/out interaction

#let's run this with the %R channel data

m3c_rMean<- glmmTMB(Swim ~ 
                Condition * log(rMean_OG) + Predator +
                (Mass)+
               (1|Tad_ID), 
              data = activity, family = nbinom1) 

summary(m3c_rMean) #same result!
simulationOutput <- simulateResiduals(fittedModel = m3c_rMean)
plot(simulationOutput)

#tab model for photography data
tab_model(m3OG, 
          transform = NULL,
          show.ci = F, 
          show.est = T, 
          show.se = T, 
          show.stat = T,
          show.obs = F,
          show.r2 = F,
          string.stat = "z value",
          string.se = "SE", 
          dv.labels = "<i>O. pumilio</i> Activity (swim counts)",
          pred.labels = c("(Intercept)",
                         "Condition [White]",
                         "log(% R-ch reflectance)", 
                         "Predator [Spider]",
                         "Predator [Cons.]", 
                         "Mass", 
                         "Condition [White]: log(% R-ch reflectance)"))

############################
##### Absolute vs. Relative Tadpole Size #####
############################ 

#best model for zone 1 was m3c, which found (1) interaction between background*intensity, (2) tadpole mass, and (3) background w/out interaction

#let's run this with mass difference data

m3d.md <- glmmTMB(Swim ~ 
                Condition * Mean_Wave + Predator + 
                mass_diff_cons+ (1|Tad_ID), 
              data = activity, family = nbinom1) 
summary(m3d.md)
simulationOutput <- simulateResiduals(fittedModel = m3d.md)
plot(simulationOutput)


```

Well that sure was fun. In the code above we were able to show that models with mass difference between tadpoles or focal tadpole mass yielded the same results as did models parameterized with either photography or spectrophotometry data. Cool beans!

Now let's get some plotting fun, huh?

#Black and White background choice
```{r PLOTTING: B + W Choice}

#White/black preference ####

#With mean wave
ggplot(bw_choice_las, aes(x = Mass, y = p_black))+
  annotate(geom = "rect", 
           fill = "black",
           color = "black",
           alpha = 0.5,
           xmin = -Inf,
           xmax = Inf,
           ymin = 0.5,
           ymax = Inf)+
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "white") + 
  geom_point(size = 3, shape = 21, stroke = 1.5, 
             aes(fill = Mean_Wave)) +  #rMean_OG
  ylab("Prp. spent on black background")+
  xlab("Tadpole mass (g)") + 
  scale_fill_gradient(low = "white", high = "#5c1f27", 
  name = "Mean absorbance coefficient") 

```

#Zone 1 choice

```{r Zone 1 with Spectral Data}

## ** favourite ** ##

## MEAN WAVELENGTH AND POOL CHOICE FACET BY PREDATOR
ggplot(activity, aes( y = pr_z1, x = Predator, colour = Predator)) + 
annotate(geom = "rect", 
             xmin = -Inf, xmax = 1.5, 
             ymin = -Inf, ymax = Inf, 
             fill = "lightgreen", 
             alpha = 0.2)+
geom_jitter(size = 3,stroke = 1, alpha = 0.3, 
            height = 0, width = 0.08) +
  geom_rect( data = data.frame(Condition = "Black"),
            aes(ymin = 0.35, ymax = 0.55, xmin = -Inf, xmax = Inf), 
            inherit.aes = F, fill = "lightgrey", colour = "black", 
            alpha = 0.4, linetype = "dashed", size = 0.2) + 
 geom_rect( data = data.frame(Condition = "White"),
            aes(ymin = 0.15, ymax = 0.35, xmin = -Inf, xmax = Inf), 
            inherit.aes = F, fill = "lightgrey", colour = "black", 
            alpha = 0.4, linetype = "dashed", size = 0.2) + 
facet_wrap(~ Condition)+
  stat_summary(fun.data = mean_cl_boot, #lets look at mean instead of median
                 geom = "pointrange", # could also do crossbar, errorbar
                 shape = 21,
                 stroke = 1.5,
                 color = "black",
                 fill = "white",
                 size = 0.8) +
ylab("Proportion spent in zone 1") +
scale_color_brewer(palette = "Accent")+
coord_cartesian(ylim = c(0,1)) + 
theme(legend.position = "None")


##### Weak 3 way interaction from model op_zone1_m1_full #####

ggplot(activity, aes(y = pr_z1, x = rMean_OG , color = Predator)) + #Mean_wave  
geom_point(size = 2, shape = 21, stroke = 1)+
    facet_wrap(~ Condition + Predator) +
    stat_smooth(method = "gam", 
                formula = y ~ s(x, bs = "cs"), 
                aes(fill = Predator), 
                alpha = 0.2)+ #y ~ s(x, bs = "cs"), log(x)
    ylab("Proportion spent in Zone 1") +
    xlab("% R-channel Reflectance") + 
    scale_color_brewer(palette = "Accent") +
    scale_fill_brewer(palette = "Accent") +
    coord_cartesian(ylim = c(0,1)) + 
  theme(legend.position = "None")

```

#Swimming

```{r PLOTTING: SWIM AND SPECTRAL}

#Swimming activity FACETED BY CONDITION
pum_swim<-
ggplot(activity, aes( y = pr_swim, x = rMean_OG)) + #Mean_Wave
geom_point(size = 3, shape = 21, stroke = 1, 
           aes(fill = rMean_OG), alpha = 0.7) + #Mean_Wave
    facet_wrap(~ Condition) +
     stat_smooth(method = "gam", 
               formula = y ~ x, 
                aes(colour = Predator), 
               alpha = 0.1, 
               linetype = "dashed",
               size = 0.5,
               fill = NA)+
       stat_smooth(method = "gam", 
               formula = y ~ poly(x,1), #log(x) 
               color = "black", 
               size = 1, 
               fullrange = T)+
  ylab("Proportion of time spent swimming") +
   xlab("% R-channel reflectance") + 
  #expression(Nursery~mean~wavelength~Delta * tilde(nu)/cm^-1)
 scale_fill_gradient(high = "white", low = "#5c1f27", 
                    name = "%R channel reflectance") +
  #expression(Delta * tilde(nu)/cm^-1)
geom_richtext(data = data.frame(Condition = "White"),
     aes(x = 42, y =0.25), color = "black", 
     label = "Light nursery tadpoles swim<br>**more** in white conditions", size = 3)+
geom_richtext(data = data.frame(Condition = "White"),
     aes(x = 20, y = 0.03), color = "black", 
     label = "Dark nursery tadpoles swim<br>**less** in white conditions", size = 3)+
coord_cartesian(ylim = c(0, 1))+
scale_color_brewer(palette = "Accent") + 
theme(legend.text = element_text(size = 10), 
        legend.title = element_text(size = 10)) + 
  labs(tag = "A")

pum_swim


#Swimming activity FACETED BY CONDITION
pum_mass<- 
ggplot(activity, aes( y = pr_swim , x = Mass)) +
geom_point(size = 3, shape = 21, stroke = 1, alpha = 0.6, 
           fill = "lightblue") +
       stat_smooth(method = "glm", 
               formula = y ~ (x), 
               color = "black", 
               size = 1)+
         stat_smooth(method = "gam", 
               geom = "ribbon",
               linetype = "dashed",
               colour = "black",
               fill = NA,
               formula = y ~ x)+
    ylab("Proportion of time spent swimming") +
   xlab("Focal tadpole mass (g)") +
   labs(tag = "B") + 
  coord_cartesian(ylim = c(0,1))

pum_mass

grid.arrange(pum_swim, pum_mass, heights = c(0.60, 0.40))

```


### PHOTOGRAPHY AND COLOUR ###
Alright, as you know we also have these photos that were taken the day that the water samples were collected.


```{r Photography and R channel}

#Red channel analysis validated by Fouilloux et al. 2022 Frontiers in Biology that hypothesized about r-channel and increasingly red/turbid environments.

ggplot(las, aes(x = Mean_Wave, y = rMean_OG)) + 
  geom_point(aes(fill = Mean_Wave), shape = 21, size = 3) + 
  stat_smooth(method = "gam", 
              formula = y ~ log(x), 
              color = "black") +
    #stat_smooth(method = "gam", 
              #formula = y ~ (x), 
             # color = "blue") +
   scale_fill_gradient(low = "white", high = "#5c1f27", 
                    name = "Mean absorbance coefficient") +
  ylab("% R-channel reflectance ") + 
  theme(legend.position = "None")

#it also works for the other channels


```

























