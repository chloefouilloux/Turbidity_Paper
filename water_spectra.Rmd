---
title: "spec analysis"
author: "Chloe Fouilloux"
date: '2022-08-08'
output: html_document
---

```{r Load Packages}
library(ggplot2)
library(dplyr)
library(gghighlight)
library(hyperSpec)
library(RColorBrewer)
library(ggtext)

#Theme Set----
theme_set(  theme(legend.position = "right",
                  strip.background = element_rect(fill = "White"),
                  panel.background = element_rect(fill = "white",
                                                  colour = "black"), 
                  panel.grid.major = element_line(size = 0), 
                  panel.grid.minor = element_line(size = 0), 
                  text = element_text(size = 14)))
```

Alright, let's try with one pool and all of its replicates

We will be converting absorbance into transmittance, Abs = log(1/T)

10^Abs = 1/T
T = 1/10^Abs

```{r}

#POOL 001, ONLY ONE REPLICATE AS IT WAS USED FOR TRANIING
las1a<- read.csv("las-001-a-DataSet1.csv", header = F)
las1a$replicate<- "a"
las1b<- read.csv("las-001-b-DataSet1.csv", header = F)
las1b$replicate<- "b"
las1c<- read.csv("las-001-diluted5-DataSet1.csv", header = F)
las1c$replicate<- "c"

las001<- las1c

las001_cut<- las001 %>%
     filter(V1 >= 300) %>%
     filter(V1 <= 700) %>%
     filter(V2 <= 1) %>% #less than or equal to 1
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #transmittance
               ave = mean(V2),  
               Pool_ID = "001") %>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 002
las2a<- read.csv("las-002-a-DataSet1.csv", header = F)
las2a$replicate<- "a"
las2b<- read.csv("las-002-b-DataSet1.csv", header = F)
las2b$replicate<- "b"

las002<- rbind(las2a, las2b)

las002_cut<- las002 %>%
             filter(V2 < 1) %>% #V2 = spc
          filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2), 
               Pool_ID = "002")%>%
              group_by(replicate) %>% #now look at each of the technical replicates please
             mutate(max_trans = max(trans)) %>% #within each replicate, please give me the max transmittance
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans)) #take the average between these three replicates

#POOL 003
las3a<- read.csv("las-003-a-DataSet1.csv", header = F)
las3a$replicate<- "a"
las3b<- read.csv("las-003-b-DataSet1.csv", header = F)
las3b$replicate<- "b"
las3c<- read.csv("las-003-c-DataSet1.csv", header = F)
las3c$replicate<- "c"

las003<- rbind(las3a, las3b, las3c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las003_cut<- las003 %>%
             filter(V2 < 1) %>% #V2 = spc
             filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "003") %>%
             group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 004
las4a<- read.csv("las-004-a-DataSet1.csv", header = F)
las4a$replicate<- "a"
las4b<- read.csv("las-004-b-DataSet1.csv", header = F)
las4b$replicate<- "b"
las4c<- read.csv("las-004-c-DataSet1.csv", header = F)
las4c$replicate<- "c"

las004<- rbind(las4a, las4b, las4c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las004_cut<- las004 %>%
             filter(V2 < 1) %>% #V2 = spc
             filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "004")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 005
las5a<- read.csv("las-005-a-DataSet1.csv", header = F)
las5a$replicate<- "a"
las5b<- read.csv("las-005-b-DataSet1.csv", header = F)
las5b$replicate<- "b"
las5c<- read.csv("las-005-c-DataSet1.csv", header = F)
las5c$replicate<- "c"

las005<- rbind(las5a, las5b, las5c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las005_cut<- las005 %>%
             filter(V2 < 1) %>% #V2 = spc
              filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "005")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 006
las6a<- read.csv("las-006-a-DataSet1.csv", header = F)
las6a$replicate<- "a"
las6b<- read.csv("las-006-b-DataSet1.csv", header = F)
las6b$replicate<- "b"
las6c<- read.csv("las-006-c-DataSet1.csv", header = F)
las6c$replicate<- "c"

las006<- rbind(las6a, las6b, las6c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las006_cut<- las006 %>%
             filter(V2 < 1) %>% #V2 = spc
             filter(V1 >= 300) %>%
            filter(V1 <= 700) %>%
             mutate(
             wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "006")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 007
las7a<- read.csv("las-007-a-DataSet1.csv", header = F)
las7a$replicate<- "a"
las7b<- read.csv("las-007-b-DataSet1.csv", header = F)
las7b$replicate<- "b"
las7c<- read.csv("las-007-c-DataSet1.csv", header = F)
las7c$replicate<- "c"

las007<- rbind(las7a, las7b, las7c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las007_cut<- las007 %>%
             filter(V2 < 1) %>% #V2 = spc
             filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
             wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "007")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 008
las8a<- read.csv("las-008-a-DataSet1.csv", header = F)
las8a$replicate<- "a"
las8b<- read.csv("las-008-b-DataSet1.csv", header = F)
las8b$replicate<- "b"
las8c<- read.csv("las-008-c-DataSet1.csv", header = F)
las8c$replicate<- "c"

las008<- rbind(las8a, las8b, las8c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las008_cut<- las008 %>%
             filter(V2 < 1) %>% #V2 = spc
            filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "008")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 009
las9a<- read.csv("las-009-a-DataSet1.csv", header = F)
las9a$replicate<- "a"
las9b<- read.csv("las-009-b-DataSet1.csv", header = F)
las9b$replicate<- "b"
las9c<- read.csv("las-009-c-DataSet1.csv", header = F)
las9c$replicate<- "c"

las009<- rbind(las9a, las9b, las9c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las009_cut<- las009 %>%
             filter(V2 < 1) %>% #V2 = spc
              filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
           wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "009")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 010
las10a<- read.csv("las-010-a-DataSet1.csv", header = F)
las10a$replicate<- "a"
las10b<- read.csv("las-010-b-DataSet1.csv", header = F)
las10b$replicate<- "b"
las10c<- read.csv("las-010-c-DataSet1.csv", header = F)
las10c$replicate<- "c"

las010<- rbind(las10a, las10b, las10c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las010_cut<- las010 %>%
             filter(V2 < 1) %>% #V2 = spc
           filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "010")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 011
las11a<- read.csv("las-011-a-DataSet1.csv", header = F)
las11a$replicate<- "a"
las11b<- read.csv("las-011-b-DataSet1.csv", header = F)
las11b$replicate<- "b"
las11c<- read.csv("las-011-c-DataSet1.csv", header = F)
las11c$replicate<- "c"

las011<- rbind(las11a, las11b, las11c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las011_cut<- las011 %>%
             filter(V2 < 1) %>% #V2 = spc
           filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "011")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 012
las12a<- read.csv("las-012-a-DataSet1.csv", header = F)
las12a$replicate<- "a"
las12b<- read.csv("las-012-b-DataSet1.csv", header = F)
las12b$replicate<- "b"
las12c<- read.csv("las-012-c-DataSet1.csv", header = F)
las12c$replicate<- "c"

las012<- rbind(las12a, las12b, las12c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las012_cut<- las012 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
             wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "012")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 013
las13a<- read.csv("las-013-a-DataSet1.csv", header = F)
las13a$replicate<- "a"
las13b<- read.csv("las-013-b-DataSet1.csv", header = F)
las13b$replicate<- "b"
las13c<- read.csv("las-013-c-DataSet1.csv", header = F)
las13c$replicate<- "c"

las013<- rbind(las13a, las13b, las13c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las013_cut<- las013 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "013")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 014
las14a<- read.csv("las-014-a-DataSet1.csv", header = F)
las14a$replicate<- "a"
las14b<- read.csv("las-014-b-DataSet1.csv", header = F)
las14b$replicate<- "b"
las14c<- read.csv("las-014-c-DataSet1.csv", header = F)
las14c$replicate<- "c"

las014<- rbind(las14a, las14b, las14c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las014_cut<- las014 %>%
             filter(V2 < 1) %>% #V2 = spc
              filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
           wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "014")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 015
las15a<- read.csv("las-015-a-DataSet1.csv", header = F)
las15a$replicate<- "a"
las15b<- read.csv("las-015-b-DataSet1.csv", header = F)
las15b$replicate<- "b"
las15c<- read.csv("las-015-c-DataSet1.csv", header = F)
las15c$replicate<- "c"

las015<- rbind(las15a, las15b, las15c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las015_cut<- las015 %>%
             filter(V2 < 1) %>% #V2 = spc
             filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "015")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 016
las16a<- read.csv("las-016-a-DataSet1.csv", header = F)
las16a$replicate<- "a"
las16b<- read.csv("las-016-b-DataSet1.csv", header = F)
las16b$replicate<- "b"
las16c<- read.csv("las-016-c-DataSet1.csv", header = F)
las16c$replicate<- "c"

las016<- rbind(las16a, las16b, las16c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las016_cut<- las016 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "016")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 017
las17a<- read.csv("las-017-a-DataSet1.csv", header = F)
las17a$replicate<- "a"
las17b<- read.csv("las-017-b-DataSet1.csv", header = F)
las17b$replicate<- "b"
las17c<- read.csv("las-017-c-DataSet1.csv", header = F)
las17c$replicate<- "c"

las017<- rbind(las17a, las17b, las17c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las017_cut<- las017 %>%
             filter(V2 < 1) %>% #V2 = spc
              filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
             wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "017")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 018
las18a<- read.csv("las-018-a-DataSet1.csv", header = F)
las18a$replicate<- "a"
las18b<- read.csv("las-018-b-DataSet1.csv", header = F)
las18b$replicate<- "b"
las18c<- read.csv("las-018-c-DataSet1.csv", header = F)
las18c$replicate<- "c"

las018<- rbind(las18a, las18b, las18c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las018_cut<- las018 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "018")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 019
las19a<- read.csv("las-019-a-DataSet1.csv", header = F)
las19a$replicate<- "a"
las19b<- read.csv("las-019-b-DataSet1.csv", header = F)
las19b$replicate<- "b"
las19c<- read.csv("las-019-c-DataSet1.csv", header = F)
las19c$replicate<- "c"

las019<- rbind(las19a, las19b, las19c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las019_cut<- las019 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
             wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "019")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 020
las20a<- read.csv("las-020-a-DataSet1.csv", header = F)
las20a$replicate<- "a"
las20b<- read.csv("las-020-b-DataSet1.csv", header = F)
las20b$replicate<- "b"
las20c<- read.csv("las-020-c-DataSet1.csv", header = F)
las20c$replicate<- "c"

las020<- rbind(las20a, las20b, las20c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las020_cut<- las020 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "020")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 020
las20a<- read.csv("las-020-a-DataSet1.csv", header = F)
las20a$replicate<- "a"
las20b<- read.csv("las-020-b-DataSet1.csv", header = F)
las20b$replicate<- "b"
las20c<- read.csv("las-020-c-DataSet1.csv", header = F)
las20c$replicate<- "c"

las020<- rbind(las20a, las20b, las20c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las020_cut<- las020 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "020")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 021
las21a<- read.csv("las-021-a-DataSet1.csv", header = F)
las21a$replicate<- "a"
las21b<- read.csv("las-021-b-DataSet1.csv", header = F)
las21b$replicate<- "b"
las21c<- read.csv("las-021-c-DataSet1.csv", header = F)
las21c$replicate<- "c"

las021<- rbind(las21a, las21b, las21c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las021_cut<- las021 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "021")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 022
las22a<- read.csv("las-022-a-DataSet1.csv", header = F)
las22a$replicate<- "a"
las22b<- read.csv("las-022-b-DataSet1.csv", header = F)
las22b$replicate<- "b"
las22c<- read.csv("las-022-c-DataSet1.csv", header = F)
las22c$replicate<- "c"

las022<- rbind(las22a, las22b, las22c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las022_cut<- las022 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "022")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 023
las23a<- read.csv("las-023-a-DataSet1.csv", header = F)
las23a$replicate<- "a"
las23b<- read.csv("las-023-b-DataSet1.csv", header = F)
las23b$replicate<- "b"
las23c<- read.csv("las-023-c-DataSet1.csv", header = F)
las23c$replicate<- "c"

las023<- rbind(las23a, las23b, las23c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las023_cut<- las023 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "023")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 024
las24a<- read.csv("las-024-a-DataSet1.csv", header = F)
las24a$replicate<- "a"
las24b<- read.csv("las-024-b-DataSet1.csv", header = F)
las24b$replicate<- "b"
las24c<- read.csv("las-024-c-DataSet1.csv", header = F)
las24c$replicate<- "c"

las024<- rbind(las24a, las24b, las24c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las024_cut<- las024 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "024")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 025
las25a<- read.csv("las-025-a-DataSet1.csv", header = F)
las25a$replicate<- "a"
las25b<- read.csv("las-025-b-DataSet1.csv", header = F)
las25b$replicate<- "b"
las25c<- read.csv("las-025-c-DataSet1.csv", header = F)
las25c$replicate<- "c"

las025<- rbind(las25a, las25b, las25c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las025_cut<- las025 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "025")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 026
las26a<- read.csv("las-026-a-DataSet1.csv", header = F)
las26a$replicate<- "a"
las26b<- read.csv("las-026-b-DataSet1.csv", header = F)
las26b$replicate<- "b"

las026<- rbind(las26a, las26b)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las026_cut<- las026 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "026")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 027
las27a<- read.csv("las-027-a-DataSet1.csv", header = F)
las27a$replicate<- "a"
las27b<- read.csv("las-027-b-DataSet1.csv", header = F)
las27b$replicate<- "b"
las27c<- read.csv("las-027-c-DataSet1.csv", header = F)
las27c$replicate<- "c"

las027<- rbind(las27a, las27b, las27c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las027_cut<- las027 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "027")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 028
las28a<- read.csv("las-028-a-DataSet1.csv", header = F)
las28a$replicate<- "a"
las28b<- read.csv("las-028-b-DataSet1.csv", header = F)
las28b$replicate<- "b"
las28c<- read.csv("las-028-c-DataSet1.csv", header = F)
las28c$replicate<- "c"

las028<- rbind(las28a, las28b, las28c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las028_cut<- las028 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "028")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 029
las29a<- read.csv("las-029-a-DataSet1.csv", header = F)
las29a$replicate<- "a"
las29b<- read.csv("las-029-b-DataSet1.csv", header = F)
las29b$replicate<- "b"

las029<- rbind(las29a, las29b)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las029_cut<- las029 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
              wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "029")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

#POOL 030
las30a<- read.csv("las-030-a-DataSet1.csv", header = F)
las30a$replicate<- "a"
las30b<- read.csv("las-030-b-DataSet1.csv", header = F)
las30b$replicate<- "b"
las30c<- read.csv("las-030-c-DataSet1.csv", header = F)
las30c$replicate<- "c"

las030<- rbind(las30a, las30b, las30c)

#alright, so we know that we only want an intensity below one, and visible spetra are 
#from 400-750nm¨

las030_cut<- las030 %>%
             filter(V2 < 1) %>% #V2 = spc
               filter(V1 >= 300) %>%
               filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #tranmittance
               ave = mean(V2),
               Pool_ID = "030")%>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

```

What if we then did a mega concatination?

```{r Giant Concat}

las_mega <- bind_rows(las001_cut, las002_cut, las003_cut, las004_cut, las005_cut,
                      las006_cut, las007_cut, las008_cut,las008_cut,
                      las008_cut, las009_cut,las010_cut, las011_cut,
                      las012_cut, las013_cut, las014_cut, las015_cut,
                      las016_cut, las017_cut, las018_cut, las019_cut,
                      las020_cut, las021_cut, las022_cut, las023_cut,
                      las024_cut, las025_cut, las026_cut, las027_cut,
                      las028_cut, las029_cut, las030_cut) %>%
            select(!c(V1, V2))%>%
            mutate(Pool_ID = as.factor(Pool_ID),
                   Replicate = as.factor(replicate),
                   Pool = forcats::fct_reorder(Pool_ID, -ave)) %>%
            group_by(Pool_ID) %>%
            mutate(ranges = max(abs)-min(abs))%>%
            #filter(wavelength < 700.5) %>%
            #filter(wavelength > 299) %>%
            ungroup()
  
#for smaller more manageable dataset 
las_unique <- las_mega %>%
              group_by(Pool_ID) %>%
              distinct(Pool_ID, ranges, abs, ave, ave_max_trans) # ave = mean wavelength

```

Here we aree going to steard breaking down spectral means and whatnot:

```{r Ggplotting- Spectral Means}

#VALUE OF USING SPECTRAL MEANS
train<- ggplot()+
  #geom_point() + 
    geom_line(data = las017_cut, aes(x = wavelength, y = trans, 
                                   color = replicate))+
  geom_line(data =las017_cut, aes(x = wavelength, y = trans, color = replicate, group = Pool_ID), color = "lightgrey", alpha = 0.3)+
  geom_hline(yintercept = las017_cut$ave_max_trans, linetype = "dashed")+
  geom_line(data = las027_cut, aes(x = wavelength, y = trans, 
                                   color = replicate))+
  geom_line(data =las027_cut, aes(x = wavelength, y = trans, color = replicate, group = Pool_ID), color = "lightgrey", alpha = 0.3)+
  geom_hline(yintercept = las027_cut$ave_max_trans, linetype = "dashed")+
  ylab("Transmission")+
  scale_color_brewer(palette = "Paired")+
  xlab("Wavelength (nm)")+ #expression(Wavelength ~ Delta * tilde(nu)/cm^-1)
  coord_cartesian(ylim = c(0,1.05), 
                  xlim = c(315, 700))+  
  theme(legend.position = "None", 
         text = element_text(size = 16))

train

ggsave("spectral_demo.png", plot = train, height = 7.36, width = 8.7)

```

Let's compare spectral means to the full RGB space

```{r RGB values and Spectral Means Example}

ggplot()+
  #geom_point() + 
    geom_line(data = las024_cut, aes(x = wavelength, y = trans, 
                                   color = replicate))+
  geom_line(data =las024_cut, aes(x = wavelength, y = trans, color = replicate, group = Pool_ID), color = "lightgrey", alpha = 0.3)+  ylab("Transmittance (T)")+
  scale_color_brewer(palette = "Paired")+
  
  #red. channel (reference)
 geom_vline(xintercept = 650, color = "red")+
    annotate(geom = "rect", 
           xmin = 635, xmax = 665, 
           ymin = -Inf, ymax = Inf, 
           fill = "pink", 
           alpha = 0.2)+
    geom_point(aes(x = 650, y = 1), colour = "red", size = 3)+
geom_richtext(aes(x = 650, y =0.3), color = "black", 
              angle = 270,
                label = "**Red: 1 (reference value)**
                         % R-ch reflectance = 12.37", size = 4)+
    
  #green channel
 geom_vline(xintercept = 550, color = "green")+
  annotate(geom = "rect", 
           xmin = 535, xmax = 565, 
           ymin = -Inf, ymax = Inf, 
           fill = "lightgreen", 
           alpha = 0.2)+
    geom_point(aes(x = 550, y = 0.79), colour = "darkgreen", size = 3)+

  geom_richtext(aes(x = 550, y =0.3), color = "black", 
              angle = 270,
                label = "**Green: 0.79**
                         % G-ch reflectance = 9.77", size = 4)+
  
  #blue channel
 geom_vline(xintercept = 450, color = "blue")+
      annotate(geom = "rect", 
           xmin = 435, xmax = 465, 
           ymin = -Inf, ymax = Inf, 
           fill = "lightblue", 
           alpha = 0.2)+
    geom_richtext(aes(x = 450, y =0.3), color = "black", 
              angle = 270,
                label = "**Blue: 0.62**
                         % B-ch reflectance = 7.75", size = 4)+
      geom_text(color = "black", label = "Pool LAS024", 
            check_overlap = T, size = 5,  
            aes(x = 345, y = 1))+
      geom_point(aes(x = 450, y = 0.62), colour = "blue", size = 3)+

  xlab(expression(Wavelength ~ Delta * tilde(nu)/cm^-1))+
  coord_cartesian(ylim = c(0,1), 
                  xlim = c(315, 700))+  
  theme(legend.position = "None", 
         text = element_text(size = 16)) +
  scale_y_continuous(sec.axis = sec_axis(trans = ~., name = "Proportion relative to R-ch reflectance"))

?geom_richtext

```





```{r Giant concate plots}
#This one take about 30 seconds to load
#There exists variation in the sampled pools, and spectra averages are a good summary of overall color capture of darker vs. lighter

## Similar to graph above, but grouped by replicate.
spec_div<- 
ggplot(las_mega, aes(x = wavelength, y = trans)) + 
  #geom_point() + 
  #geom_path()+
  geom_line(aes(group = replicate))+
  geom_line(aes(group = Pool), color = "lightgrey", 
            alpha = 0.7)+
  geom_hline(aes(yintercept = ave_max_trans, color = Pool), 
             linetype = "dashed", size = 1)+
 # gghighlight(mean(intensity) > 0.75 | mean(intensity) < 0.15, 
             # use_direct_label = F, calculate_per_facet = T)+
  facet_wrap(~ Pool) +
  theme(legend.position = "None")+
  ylab("Transmission")+
  xlab(expression(Wavelength ~ Delta * tilde(nu)/cm^-1))

spec_div

ggsave("specdiv.png", plot = spec_div, height = 7, width = 12)

```


intensity vs. ranges

So **INTENSITY** here is a stand-in for overall colour/turbidity, where higher averages have higher peaks across the colour spectrum, leading to overall darker water (pers. obs). On the other hand, **RANGE** is calculated as the maximum intensity- minimum intensity *WITHIN* a pool-- the idea here is that the pools with larger ranges are more turbid because there is more suspended stuff floating around (and consequently falling down) as samples get processed.

```{r Intensity vs. Ranges}
#Ranges and average pool intensity
av_int<- ggplot(las_unique, aes(x = ave, y = ranges, color = Pool_ID)) + 
  geom_point(shape = 21,  size = 2, 
             stroke = 1.2)+ #alpha = 0.3,
   stat_smooth(method = "gam", 
              formula = y ~ x, #log(x)
              color = "black", 
              fill = NA)+
  stat_smooth(method = "gam", 
              geom = "ribbon",
              formula = y ~ x, #log(x)
              color = "black", 
              fill = "lightgrey", 
              alpha = 0.2, 
              linetype = "dashed")+
  theme(legend.position = "None")+
  ylab("Pool intensity range")+
  xlab("Average pool intensity (arbitrary units)")

ggsave("av_int.png", plot = av_int)

```


```{r}
set.seed(1)
las3<- new("hyperSpec", spc = as.numeric(las003$V2), wavelength = as.numeric(las003$V1))

las3

faux_cell_preproc <- faux_cell - spc_fit_poly_below(faux_cell)
faux_cell_preproc <- faux_cell_preproc / rowMeans(faux_cell)
faux_cell_preproc <- faux_cell_preproc - quantile(faux_cell_preproc, 0.05)

cluster_cols <- c("dark blue", "orange", "#C02020")
cluster_meansd <- aggregate(faux_cell_preproc, faux_cell$region, mean_pm_sd)
cluster_means <- aggregate(faux_cell_preproc, faux_cell$region, mean)
```

Preliminary Calculations For some plots of the faux_cell dataset, the pre-processed spectra and their cluster averages ± one standard deviation are more suitable:

```{r}
set.seed(1)
faux_cell <- generate_faux_cell()

faux_cell_preproc <- faux_cell - spc_fit_poly_below(faux_cell)
faux_cell_preproc <- faux_cell_preproc / rowMeans(faux_cell)
faux_cell_preproc <- faux_cell_preproc - quantile(faux_cell_preproc, 0.05)

cluster_cols <- c("dark blue", "orange", "#C02020")
cluster_meansd <- aggregate(faux_cell_preproc, faux_cell$region, mean_pm_sd)
cluster_means <- aggregate(faux_cell_preproc, faux_cell$region, mean)
```


Converting spectrophotometer spectra to RGB

https://book.colrverse.com/importing-processing-and-visualising-data.html

https://github.com/rmaia/pavo/tree/master/data_external/vignette

https://rdrr.io/cran/pavo/man/spec2rgb.html

https://stackoverflow.com/questions/3407942/rgb-values-of-visible-spectrum

```{r Pavo Script}
getwd()

library(pavo)

#### #### ####
#preparing df for pavo analysis
#### #### ####

#exception for las001 and las002
las001_300_700<- las001 %>%
     filter(V1 >= 300) %>%
     filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #transmittance
               ave = mean(V2),  
               Pool_ID = "001") %>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

las001_pavo <- las001_300_700 %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las001_pavo , file="/Users/chloefouilloux/Desktop/spc_test/ex/las001_pavo.csv",
          row.names=FALSE)

las002_300_700<- las002 %>%
     filter(V1 >= 300) %>%
     filter(V1 <= 700) %>%
             mutate(
               wavelength = V1, 
               abs = V2,
               trans = 1/(10^abs), #transmittance
               ave = mean(V2),  
               Pool_ID = "002") %>%
              group_by(replicate) %>%
             mutate(max_trans = max(trans)) %>%
             ungroup() %>%
             mutate(ave_max_trans = mean(max_trans))

las002_pavo <- las002_300_700 %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las002_pavo , file="/Users/chloefouilloux/Desktop/spc_test/ex/las002_pavo.csv",
          row.names=FALSE)


las005_pavo <- las005_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las005_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las005_pavo.csv",
          row.names=FALSE)

las006_pavo <- las006_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las006_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las006_pavo.csv",
          row.names=FALSE)

las007_pavo <- las007_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las007_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las007_pavo.csv",
          row.names=FALSE)

las008_pavo <- las008_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las008_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las008_pavo.csv",
          row.names=FALSE)

las009_pavo <- las009_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las009_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las009_pavo.csv",
          row.names=FALSE)

las010_pavo <- las010_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las010_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las010_pavo.csv",
          row.names=FALSE)

las013_pavo <- las013_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las013_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las013_pavo.csv",
          row.names=FALSE)

las014_pavo <- las014_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las014_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las014_pavo.csv",
          row.names=FALSE)

las015_pavo <- las015_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las015_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las015_pavo.csv",
          row.names=FALSE)

las016_pavo <- las016_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las016_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las016_pavo.csv",
          row.names=FALSE)

las017_pavo <- las017_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las017_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las017_pavo.csv",
          row.names=FALSE)

las018_pavo <- las018_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las018_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las018_pavo.csv",
          row.names=FALSE)

las019_pavo <- las019_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las019_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las019_pavo.csv",
          row.names=FALSE)

las020_pavo <- las020_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las020_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las020_pavo.csv",
          row.names=FALSE)

las021_pavo <- las021_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las021_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las021_pavo.csv",
          row.names=FALSE)

las022_pavo <- las022_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las022_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las022_pavo.csv",
          row.names=FALSE)


las023_pavo <- las023_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las023_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las023_pavo.csv",
          row.names=FALSE)

las024_pavo <- las024_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las024_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las024_pavo.csv",
          row.names=FALSE)

las025_pavo <- las025_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las025_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las025_pavo.csv",
          row.names=FALSE)

las026_pavo <- las026_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las026_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las026_pavo.csv",
          row.names=FALSE)

las027_pavo <- las027_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las027_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las027_pavo.csv",
          row.names=FALSE)

las028_pavo <- las028_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las028_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las028_pavo.csv",
          row.names=FALSE)

las029_pavo <- las029_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las029_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las029_pavo.csv",
          row.names=FALSE)

las030_pavo <- las030_cut %>%
               mutate(refl= trans *100) %>%
               select(wavelength, refl) %>%
               rename(wl = wavelength)

write.csv(las030_pavo , file="/Users/chloefouilloux/Desktop/spc_test/las030_pavo.csv",
          row.names=FALSE)

specs <- getspec("/Users/chloefouilloux/Desktop/spc_test",
  ext = "csv",
  sep = ",",
  subdir = TRUE,
  subdir.names = FALSE) #these are correctly loaded, but not the correct value is taken here.

explorespec(specs[, 1:3]) #this looks at %reflectance and not absorption
spec2rgb(specs, alpha = 1)

```
las005_pavo las006_pavo las007_pavo las008_pavo las009_pavo las010_pavo las013_pavo las014_pavo las015_pavo 
"#AA9179FF" "#FFDAC4FF" "#ECC8B6FF" "#E5C4AAFF" "#F3CCB5FF" "#B6A48EFF" "#F3D2BFFF" "#FFE2CDFF" "#DABDA5FF" 
las016_pavo las017_pavo las018_pavo las019_pavo las020_pavo las021_pavo las022_pavo las023_pavo las024_pavo 
"#B99F8FFF" "#AB8F7EFF" "#EECCB9FF" "#F9D6BFFF" "#C5AC9EFF" "#FFE1D3FF" "#856D5FFF" "#CCAF9CFF" "#E9C9BEFF" 
las025_pavo las026_pavo las027_pavo las028_pavo las029_pavo las030_pavo   test1.spc 
"#D4B39DFF" "#FFF7E4FF" "#FFEFDFFF" "#75675FFF" "#FFE6D7FF" "#DBBDAAFF" "#0A0E06FF" 

# Delete, not used in final script.
Removing Spectra outside mean ± n sd

```{r}
 mean_sd_filter <- function (x, n = 5) {
x <- x - mean (x)
s <- n * sd (x)
(x <= s) & (x > -s)
 }

OK <- apply (chondro [[]], 2, mean_sd_filter, n = 4) # logical matrix
 spc.OK <- chondro [apply (OK, 1, all)]
```









